# DO NOT EDIT THIS FILE!
# Please make all changes to files in ../local.
# To make changes, copy the section/stanza you want to change from ./default
# into ../local and edit there.

[SentinelOne Devices Lookup - Gen]
disabled = false
cron_schedule = 29 * * * *
description = populates kvstore lookup: sentinelone_devices
dispatch.earliest_time = -61m@m
dispatch.latest_time = -1m@m
enableSched = 1
schedule_window = auto
search = `sa_sentinelone_index` sourcetype="sentinelone:channel:agents" \
| dedup uuid\
| rex field=modelName "(?<s1_model_name>^[^-]+) - (?<s1_sys_name>[^%]+)"\
| eval\
    category=mvjoin(mvsort(lower(mvappend(\
    "gen:sa-sentinelone",\
    "s1_active_threats: ".activeThreats,\
    "s1_agent_version: ".agentVersion,\
    "s1_allow_remote_shell: ".allowRemoteShell,\
    "s1_apps_vuln_status: ".appsVulnerabilityStatus,\
    "s1_detect_state: ".detectionState,\
    "s1_encrypted_apps: ".encryptedApplications,\
    "s1_external_ip: ".externalIp,\
    "s1_firewall_enabled: ".firewallEnabled,\
    "s1_is_infected: ".infected,\
    "s1_is_active: ".isActive,\
    "s1_is_decom: ".isDecommissioned,\
    "s1_is_pending_uninstall: ".isPendingUninstall,\
    "s1_is_uninstalled: ".isUninstalled,\
    "s1_is_updated: ".isUpToDate,\
    "s1_last_active: ".strftime(strptime(lastActiveDate,"%FT%T.%6Q%Z"), "%x %T %Z"),\
    "s1_last_user: ".lastLoggedInUserName,\
    "s1_location_enabled: ".locationEnabled,\
    "s1_location_type: ".locationType,\
    "s1_device_type: ".machineType,\
    "s1_mitigate_mode: ".mitigationMode,\
    "s1_mitigate_mode_suspicious: ". mitigationModeSuspicious,\
    "s1_model_name: ".s1_model_name,\
    "s1_sys_name: ".s1_sys_name,\
    "s1_operational_state: ".operationalState,\
    "s1_os_name: ".osName,\
    "s1_os_type: ".osType,\
    "s1_ranger_status: ".rangerStatus,\
    "s1_ranger_version: ".rangerVersion,\
    "s1_remote_profile_state: ".remoteProfilingState,\
    "s1_last_scan: ".strftime(strptime(scanFinishedAt,"%FT%T.%6Q%Z"), "%x %T %Z"),\
    "s1_threat_reboot_required: ".threatRebootRequired,\
    "s1_last_updated: ".strftime(strptime(updatedAt,"%FT%T.%6Q%Z"), "%x %T %Z"),\
    "splunk_last_updated: ".strftime(now(), "%x %T %Z")\
    ))), "|"),\
    nt_host=lower(computerName),\
    dns=nt_host.".".lower(domain),\
    bunit=lower(replace(mvjoin(mvappend(groupName, siteName), ","), " ", "_")),\
    owner=lower(accountName),\
    priority=case(match(category, "domain_controller"), "critical", match(category, "server|ubuntu|rhel|linux"), "high", true(), "medium"),\
    is_expected=if(priority=="critical", "true", "false"),\
    mac=mvjoin('networkInterfaces{}.physical', "|"),\
    ip=mvjoin('networkInterfaces{}.inet{}', "|"),\
    _last_seen=now(),\
    _key=uuid\
| iplocation externalIp \
| rename lon as long, City as city, Country as country \
| table _key,_last_seen,ip,mac,nt_host,dns,owner,priority,lat,long,city,country,bunit,category,is_expected\
| outputlookup key_field=_key sentinelone_devices \
| stats count

# Deprecated
[SentinelOne Devices Lookup - Cleanup]
disabled = true
cron_schedule = 39 * * * *
description = removes old entries from kvstore lookup: sentinelone_devices
dispatch.earliest_time = -1s
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = | inputlookup sentinelone_devices \
| where _last_seen>relative_time(now(), `sa_sentinelone_retention`) \
| outputlookup sentinelone_devices \
| stats count
